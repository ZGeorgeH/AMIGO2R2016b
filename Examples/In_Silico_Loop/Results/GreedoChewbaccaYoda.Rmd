---
title: "Comparison of 10 6-hour experiment, 20 3-hour experiment and one 60-hour experiment."
author: "Ally Hume"
date: "9 February 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description


Here we compare two experiment to show the power of closed loop optimisation.  One experiment (Greedo - labelled '10x6') plans 10 6-hour experiments using OID, Experiment, PE and updates knowledge of the previous experiments and the current best parameter estimate to choose the next experiment.  Another experiment is identical but performs 20 3-hour experiments (Yoda - labelled '20x3'). The other experiment (Chewbacca - labelled '1x60') simply plans a 60-hour experiment in advance.

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(reshape2)
library(knitr)

trueValues = data.frame( param=c("alpha1","Vm1","h1","Km1","d1","alpha2","d2","Kf","Kb"),
                         trueValue=c(0.00175985449291231,0.0800887345690361,2.22548971250921,3.35948035905386,0.0100614569676223,1,1,1,1) )

load_experiment_data <- function(filename) {
  
  wholeFile <- readLines(filename)
  iterationData <- wholeFile[grep('ITERATION',wholeFile)]
  iterationData <- iterationData[grep('PARAM_FIT|REL_CONF',iterationData)]
  con <- textConnection(iterationData)
  data <- read.table(con)
  close(con)
  
  colnames(data) <- c("key", "iteration", "type", "param", "value")
  
  data <- data %>% mutate( runName = gsub('.dat','',filename))
  exptName <- filename
  exptName <- gsub('Greedo',    '10x6',  exptName)
  exptName <- gsub('Chewbacca', '1x60',  exptName)
  exptName <- gsub('Yoda',      '20x3',  exptName)
  data <- data %>% mutate( exptName = gsub('-.*','',exptName))
  
  return(data)
}
```

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# Get the data files.
files <- c(list.files(pattern='Greedo.*dat'),list.files(pattern='Chewbacca.*dat'),list.files(pattern='Yoda.*dat'))

# Read in each file, convert to a data frame and merge into one dataframe
data <- lapply(files, load_experiment_data)
data <- Reduce(function(...) merge(..., all=T), data)

# Join data with true values
data <- left_join(data,trueValues)
```

## Number of runs

```{r echo=FALSE}
d <- data %>% filter(type == 'PARAM_FIT' & param == 'alpha1' &  ((iteration == 10 & (exptName == '10x6' | exptName == '20x3')) |  (iteration == 1 & exptName == '1x60')))
d <- d %>% group_by(exptName) %>% summarise(n=n())
kable(d)
```

## Fitted parameter values after final iteration 

The fitted parameters:

```{r echo=FALSE}
d <- data %>% filter(type == 'PARAM_FIT' & ( (iteration == 10 & (exptName == '10x6' | exptName == '20x3')) |  (iteration == 1 & exptName == '1x60') ) ) %>% 
     select(exptName, param, trueValue, value) 

ggplot(data=d, aes(x=exptName,y=value)) + 
  geom_boxplot(alpha=0) + facet_wrap( ~ param, scales = "free_y") +
  geom_hline(aes(yintercept=trueValue), color='red')
```

## Relative confidence intervals

The fitted parameters:

```{r echo=FALSE}
d <- data %>% filter(type == 'REL_CONF' & ( (iteration == 10 & (exptName == '10x6' | exptName == '20x3')) |  (iteration == 1 & exptName == '1x60') ) ) %>% 
     select(exptName, param, trueValue, value) 

ggplot(data=d, aes(x=exptName,y=value)) + 
  geom_boxplot(alpha=0) + facet_wrap( ~ param, scales = "free_y") 
```


# Appendix

Various data tables if they are of interest.  Typically what is shown in box plots above.

## Fitted parameter values after final iteration 

```{r echo=FALSE}
d <- data %>% filter(type == 'PARAM_FIT' &  ( (iteration == 10 & (exptName == '10x6' | exptName == '20x3')) |  (iteration == 1 & exptName == '1x60') ) ) %>% 
     select(exptName,param, trueValue, value) %>% 
     group_by(param, exptName, trueValue) %>% 
     summarize( mean=mean(value), sd=sd(value), '25%' = quantile(value, probs=0.25), '50%' = quantile(value, probs=0.5), '75%' = quantile(value, probs=0.75),   min=min(value), max=max(value))
kable(d)
```

## Relative confidence interval values

```{r echo=FALSE}
d <- data %>% filter(type == 'REL_CONF' &  ( (iteration == 10 & (exptName == '10x6' | exptName == '20x3')) |  (iteration == 1 & exptName == '1x60') ) ) %>% 
     select(param, exptName, value) %>% 
     group_by(param, exptName) %>% 
     summarize( mean=mean(value), sd=sd(value), '25%' = quantile(value, probs=0.25), '50%' = quantile(value, probs=0.5), '75%' = quantile(value, probs=0.75))
kable(d)
```




